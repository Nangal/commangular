/**
 * Command pattern implementation for AngularJS
 * @version v0.4.2 - 2013-12-05
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){function c(a){this.commandType=a,this.descriptors=[],this.command=null,this.commandConfig,this.interceptors}function d(a){this.commandDescriptor,this.parent=a}function e(a,b,c){d.apply(this,[c]),this.key=a,this.value=b}function f(a,b,c,e){d.apply(this,[e]),this.service=a,this.property=b,this.value=c}function g(a){this.context=a,this.deferred=null}function h(a,b,c,d){g.apply(this,[b]),this.command=a,this.commandConfig=c,this.interceptors=d,this.execute=function(){var b=this,e=this.context,f=r.defer();return f.resolve(),f.promise.then(function(){return e.intercept("Before",d)}).then(function(){var f=r.defer();try{var g;d.Around?g=e.intercept("Around",d,b.command):(a=q.instantiate(b.command,b.context.contextData),g=e.invoke(a.execute,a)),e.processResults(g,c).then(function(){f.resolve()},function(a){f.reject(a)})}catch(h){e.getContextData().lastError=h,e.intercept("AfterThrowing",d).then(function(){f.reject(h.message)},function(a){f.reject(a)})}return f.promise}).then(function(){return e.intercept("After",d)})}}function i(a,b){g.apply(this,[a]),this.descriptors=b,this.start=function(){return this.deferred=r.defer(),this.execute(),this.deferred.promise}}function j(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c],d=this.context.instantiate(b);d instanceof h?d.execute().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)})},this.nextCommand=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function k(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){for(var a=this,b=0;b<this.descriptors.length;b++){var c=this.descriptors[b],d=this.context.instantiate(c);d instanceof h?d.execute().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)})}},this.checkComplete=function(){++c==this.descriptors.length&&this.deferred.resolve()}}function l(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c];if(b instanceof e)if(this.context.contextData[b.key]===b.value){var d=this.context.instantiate(b.commandDescriptor);d instanceof h?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next();if(b instanceof f){var g=q.get(b.service);if(g[b.property]===b.value){var d=this.context.instantiate(b.commandDescriptor);d instanceof h?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next()}},this.next=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function m(a){this.contextData=a||{},this.instantiator=new n,this.contextData.commandModel={},this.currentDeferred}function n(){}function o(a,b){this.deferred=b,this.context=a,this.canceled=!1}function p(a,b,c,d){o.apply(this,[c,d]),this.executed=a,this.next=b}var q,r,s=a.commangular||(a.commangular={});s.create=function(a,b,c){var d=s.commands||(s.commands={});d[a]={"function":b,config:c,interceptors:{}}},s.aspect=function(a,b,c){var d=s.aspects||(s.aspects=[]),e=/@([^(]*)\((.*)\)/.exec(a),f=e[1],g=e[2];if(!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b|\bAround\b)/.test(f))throw new Error("aspect descriptor "+a+" contains errors");d.push({poincut:f,matcher:g,aspectFunction:b,order:c})},c.prototype.asSequence=function(){return this.commandType="S",this},c.prototype.asParallel=function(){return this.commandType="P",this},c.prototype.asFlow=function(){return this.commandType="F",this},c.prototype.add=function(a){if(b.isString(a)&&(a=s.commands[a]),a instanceof c)return this.descriptors.push(a),this;var d=new c("E");return d.command=a.function,d.commandConfig=a.config,d.interceptors=a.interceptors,this.descriptors.push(d),this},c.prototype.resultLink=function(a,b){var c=new e(a,b,this);return this.descriptors.push(c),c},c.prototype.serviceLink=function(a,b,c){var d=new f(a,b,c,this);return this.descriptors.push(d),d},d.prototype.to=function(a){if(b.isString(a)&&(a=s.commands[a]),a instanceof c)return this.commandDescriptor=a,this.parent;var d=new c("E");return d.command=a.function,d.commandConfig=a.config,d.interceptors=a.interceptors,this.commandDescriptor=d,this.parent},e.prototype=new d,e.prototype.constructor=e,f.prototype=new d,f.prototype.constructor=f,h.prototype=new g,h.prototype.constructor=h,i.prototype=new g,i.prototype.constructor=i,j.prototype=new i,j.prototype.constructor=j,k.prototype=new i,k.prototype.constructor=k,k.prototype=new i,k.prototype.constructor=l,m.prototype.instantiate=function(a){var b=this.instantiator.instantiate(a,this);return b},m.prototype.processResults=function(a,b){var c=this,d=r.defer();if(!a)return d.resolve(),d.promise;r.when(a).then(function(a){c.contextData.lastResult=a,b&&b.resultKey&&(c.contextData[b.resultKey]=a),d.resolve()},function(a){d.reject(a)});return d.promise},m.prototype.invoke=function(a,b){return q.invoke(a,b,this.contextData)},m.prototype.getContextData=function(){return this.contextData},m.prototype.intercept=function(a,c,d){var e=this,f=r.defer();if(!c[a])return f.resolve(),f.promise;switch(c[a].sort(function(a,b){return b.order-a.order}),a){case"Around":var g=new p(d,null,e,f);b.forEach(c[a],function(a){g=new p(a.func,g,e,f)}),r.when(g.invoke()).then(function(a){f.resolve(a)},function(a){f.reject(a)});break;default:var g=this.contextData.processor=new o(e,f);c[a].reverse();var h=0;!function i(){try{if(h==c[a].length||g.canceled)return f.resolve(),void 0;var b=q.instantiate(c[a][h++].func,e.contextData);r.when(e.invoke(b.execute,b)).then(function(){i()})}catch(d){f.reject(d)}}()}return f.promise},n.prototype.instantiate=function(a,b){switch(a.commandType){case"S":return new j(b,a.descriptors);case"P":return new k(b,a.descriptors);case"E":return new h(a.command,b,a.commandConfig,a.interceptors);case"F":return new l(b,a.descriptors)}},o.prototype.cancel=function(){this.canceled=!0,this.deferred.reject("The command has been canceled")},o.prototype.setData=function(a,b){this.context.contextData[a]=b},o.prototype.getData=function(a){return this.context.contextData[a]},p.prototype=new o,p.prototype.constructor=p,p.prototype.invoke=function(){var a=this,b=r.defer();a.context.contextData.processor=a.next;var c=q.instantiate(a.executed,a.context.contextData);return r.when(a.context.invoke(c.execute,c)).then(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},b.module("commangular",[]).provider("$commangular",function(){var a={};return{$get:["commandExecutor",function(b){return b.descriptors=a,{dispatch:function(a,c){return b.execute(a,c)}}}],mapTo:function(b){var d=new c;return a[b]=d,d},asSequence:function(){return new c("S")},asParallel:function(){return new c("P")},asFlow:function(){return new c("F")},findCommand:function(b){return a[b]}}}),b.module("commangular").service("commandExecutor",function(){return{descriptors:{},execute:function(a,b){var c=r.defer(),d=new m(b),e=this.descriptors[a],f=d.instantiate(e);return f.start().then(function(){c.resolve()},function(a){console.log("Command context end with error :"+a),c.reject(a)}),c.promise}}}),b.module("commangular").run(["$rootScope","$commangular","$injector","$q",function(a,b,c,d){q=c,r=d;for(var e=0;e<s.aspects.length;e++){var f=s.aspects[e];if(f.order=f.order||(f.order=0),/\/(.*)\//.test(f.matcher))for(var g in s.commands){var h=new RegExp(/\/(.*)\//.exec(f.matcher)[1]);h.test(g)&&(s.commands[g].interceptors[f.poincut]||(s.commands[g].interceptors[f.poincut]=[]),s.commands[g].interceptors[f.poincut].push({func:f.aspectFunction,order:f.order}))}}a.dispatch=function(a,c){return b.dispatch(a,c)}}])}(window,angular);