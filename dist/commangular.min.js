/**
 * Command pattern implementation for AngularJS
 * @version v0.1.1 - 2013-11-14
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){function c(a){this.commandType=a,this.descriptors=[],this.command={}}function d(a){this.context=a,this.deferred=null}function e(a,b){d.apply(this,[b]),this.command=a,this.execute=function(){var a=this,b=!1;this.deferred=this.context.$q.defer();var c=this.context.$injector.instantiate(this.command,this.context.getContextData());try{var d=this.context.$injector.invoke(c.execute,this.command,this.context.getContextData()),e=this.context.processResults(d,this.deferred)}catch(f){if(b=!0,c.hasOwnProperty("onError")){var g=this.context.getContextData();g.lastError=f,this.context.$injector.invoke(c.onError,this.command,this.context.getContextData())}this.deferred.reject(f)}return c.hasOwnProperty("onComplete")&&!b&&e.then(function(){a.context.$injector.invoke(c.onComplete,a.command,a.context.getContextData())}),this.deferred.promise}}function f(a,b){d.apply(this,[a]),this.descriptors=b,this.start=function(){return this.deferred=this.context.$q.defer(),this.execute(),this.deferred.promise}}function g(a,b){f.apply(this,[a,b]),this.currentIndex=0,this.execute=function(){var a=this,b=this.descriptors[this.currentIndex],c=this.context.instanciate(b);(c instanceof g||c instanceof h)&&c.start().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)}),c instanceof e&&c.execute().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)})},this.nextCommand=function(){return++this.currentIndex==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function h(a,b){f.apply(this,[a,b]),this.totalComplete=0,this.execute=function(){for(var a=this,b=0;b<this.descriptors.length;b++){var c=this.descriptors[b],d=this.context.instanciate(c);(d instanceof g||d instanceof h)&&d.start().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)}),d instanceof e&&d.execute().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)})}},this.checkComplete=function(){++this.totalComplete==this.descriptors.length&&this.deferred.resolve()}}function i(a,b,c,d){this.contextData=d||{},this.instanciator=c,this.$injector=a,this.$q=b}function j(){return{instanciate:function(a,b){var c={};return"S"==a.commandType&&(c=new g(b,a.descriptors)),"P"==a.commandType&&(c=new h(b,a.descriptors)),"E"==a.commandType&&(c=new e(a.command,b)),c}}}var k=a.commangular||(a.commangular={});k.create=function(a,b){k.functions||(k.functions=[]),k.functions[a]=b},c.prototype.add=function(a){this.descriptors.push(a)},e.prototype=d,e.prototype.constructor=e,f.prototype=d,f.prototype.constructor=f,g.prototype=f,g.prototype.constructor=g,h.prototype=f,h.prototype.constructor=h,i.prototype.instanciate=function(a){var b=this.instanciator.instanciate(a,this);return b},i.prototype.processResults=function(a,b){var c=this;if(!a)return b.resolve(),void 0;var d=[],e=[];for(var f in a){var g=this.$q.when(a[f]);d.push(g),e.push(f)}var h=this.$q.all(d).then(function(a){for(var d=0;d<a.length;d++)c.contextData[e[d]]=a[d];b.resolve()});return h},i.prototype.getContextData=function(){return this.contextData},b.module("commangular",[]).provider("$commangular",function(){var a,d=[],e=[];return{$get:["commandExecutor",function(a){return a.descriptors=d,{dispatch:function(b,c){a.execute(b,c)}}}],asSequence:function(){return a&&e.push(a),a=new c("S"),this},asParallel:function(){return a&&e.push(a),a=new c("P"),this},add:function(d){if(b.isString(d)&&(d=this.get(d)),d instanceof c)return a.add(d),this;var e=new c("E");return e.command=d,a.add(e),this},mapTo:function(b){if(e.length>0)throw"Incorrect command structure on "+b;d[b]=a,a=null},create:function(){var b=a;return a=e.length>0?e.pop():null,b},get:function(a){return k.functions[a]}}}),b.module("commangular").service("commandExecutor",["$injector","$q",function(a,b){return{descriptors:{},execute:function(c,d){var e=new i(a,b,new j,d),f=this.descriptors[c],g=e.instanciate(f);g.start().then(function(){console.log("Command Complete")},function(a){console.log("Command context end with error :"+a)})}}}])}(window,angular);