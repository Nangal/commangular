/**
 * Command pattern implementation for AngularJS
 * @version v0.4.1 - 2013-11-21
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){function c(a){this.commandType=a,this.descriptors=[],this.command=null,this.commandConfig}function d(a){this.commandDescriptor,this.parent=a}function e(a,b,c){d.apply(this,[c]),this.key=a,this.value=b}function f(a,b,c,e){d.apply(this,[e]),this.service=a,this.property=b,this.value=c}function g(a){this.context=a,this.deferred=null}function h(a,b,c){g.apply(this,[b]),this.command=a,this.commandConfig=c,this.execute=function(){var a=this,b=!1,c=this.context.$q,d=this.context.$injector;this.deferred=c.defer();var e=d.instantiate(this.command,this.context.getContextData());try{var f=d.invoke(e.execute,this.command,this.context.getContextData()),g=this.context.processResults(f,this.deferred,this.commandConfig)}catch(h){if(b=!0,e.hasOwnProperty("onError")){var i=this.context.getContextData();i.lastError=h,d.invoke(e.onError,this.command,this.context.getContextData())}this.deferred.reject(h)}return e.hasOwnProperty("onComplete")&&!b&&g.then(function(){d.invoke(e.onComplete,a.command,a.context.getContextData())}),this.deferred.promise}}function i(a,b){g.apply(this,[a]),this.descriptors=b,this.start=function(){return this.deferred=this.context.$q.defer(),this.execute(),this.deferred.promise}}function j(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c],d=this.context.instantiate(b);d instanceof h?d.execute().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)})},this.nextCommand=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function k(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){for(var a=this,b=0;b<this.descriptors.length;b++){var c=this.descriptors[b],d=this.context.instantiate(c);d instanceof h?d.execute().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)})}},this.checkComplete=function(){++c==this.descriptors.length&&this.deferred.resolve()}}function l(a,b){i.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c];if(b instanceof e)if(this.context.contextData[b.key]===b.value){var d=this.context.instantiate(b.commandDescriptor);d instanceof h?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next();if(b instanceof f){var g=this.context.$injector.get(b.service);if(g[b.property]===b.value){var d=this.context.instantiate(b.commandDescriptor);d instanceof h?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next()}},this.next=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function m(a,b,c,d){this.contextData=d||{},this.instantiator=c,this.$injector=a,this.$q=b,this.contextData.commandModel={}}function n(){}var o=a.commangular||(a.commangular={});o.create=function(a,b,c){o.functions||(o.functions={}),o.functions[a]={"function":b,config:c}},c.prototype.asSequence=function(){return this.commandType="S",this},c.prototype.asParallel=function(){return this.commandType="P",this},c.prototype.asFlow=function(){return this.commandType="F",this},c.prototype.add=function(a){if(b.isString(a)&&(a=o.functions[a]),a instanceof c)return this.descriptors.push(a),this;var d=new c("E");return d.command=a.function,d.commandConfig=a.config,this.descriptors.push(d),this},c.prototype.resultLink=function(a,b){var c=new e(a,b,this);return this.descriptors.push(c),c},c.prototype.serviceLink=function(a,b,c){var d=new f(a,b,c,this);return this.descriptors.push(d),d},d.prototype.to=function(a){if(b.isString(a)&&(a=o.functions[a]),a instanceof c)return this.commandDescriptor=a,this.parent;var d=new c("E");return d.command=a.function,d.commandConfig=a.config,this.commandDescriptor=d,this.parent},e.prototype=new d,e.prototype.constructor=e,f.prototype=new d,f.prototype.constructor=f,h.prototype=new g,h.prototype.constructor=h,i.prototype=new g,i.prototype.constructor=i,j.prototype=new i,j.prototype.constructor=j,k.prototype=new i,k.prototype.constructor=k,k.prototype=new i,k.prototype.constructor=l,m.prototype.instantiate=function(a){var b=this.instantiator.instantiate(a,this);return b},m.prototype.processResults=function(a,b,c){var d=this;if(!a)return b.resolve(),void 0;var e=this.$q.when(a).then(function(a){d.contextData.lastResult=a,c&&c.resultKey&&(d.contextData[c.resultKey]=a),b.resolve()});return e},m.prototype.getContextData=function(){return this.contextData},n.prototype.instantiate=function(a,b){switch(a.commandType){case"S":return new j(b,a.descriptors);case"P":return new k(b,a.descriptors);case"E":return new h(a.command,b,a.commandConfig);case"F":return new l(b,a.descriptors)}},b.module("commangular",[]).provider("$commangular",function(){var a={};return{$get:["commandExecutor",function(b){return b.descriptors=a,{dispatch:function(a,c){return b.execute(a,c)}}}],mapTo:function(b){var d=new c;return a[b]=d,d},asSequence:function(){return new c("S")},asParallel:function(){return new c("P")},asFlow:function(){return new c("F")},findCommand:function(b){return a[b]}}}),b.module("commangular").service("commandExecutor",["$injector","$q",function(a,b){return{descriptors:{},execute:function(c,d){var e=b.defer(),f=new m(a,b,new n,d),g=this.descriptors[c],h=f.instantiate(g);return h.start().then(function(){e.resolve()},function(a){console.log("Command context end with error :"+a),e.reject(a)}),e.promise}}}])}(window,angular);