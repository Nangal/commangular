/**
 * Command pattern implementation for AngularJS
 * @version v0.7.1 - 2013-12-23
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){function c(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function d(a){this.commandType=a,this.descriptors=[],this.command=null,this.commandConfig,this.interceptors}function e(a){this.commandDescriptor,this.parent=a}function f(a,b,c){e.apply(this,[c]),this.key=a,this.value=b}function g(a,b,c,d){e.apply(this,[d]),this.service=a,this.property=b,this.value=c}function h(a){this.context=a,this.deferred=null}function i(a,b,c,d){h.apply(this,[b]),this.command=a,this.commandConfig=c,this.interceptors=d,this.execute=function(){var b,e=this,f=this.context,g=s.defer();return g.resolve(),g.promise.then(function(){return f.intercept("Before",d)}).then(function(){var g=s.defer();try{d.Around?b=f.intercept("Around",d,e.command):(a=f.instantiate(e.command,!0),b=f.invoke(a.execute,a)),f.processResults(b,c).then(function(){g.resolve()},function(a){g.reject(a)})}catch(h){g.reject(h)}return g.promise}).then(function(){return f.intercept("After",d)}).then(function(){f.currentCommand.hasOwnProperty("onResult")&&f.currentCommand.onResult(b)},function(a){var b=s.defer();return f.canceled?(b.reject(a),b.promise):(f.currentCommand&&f.currentCommand.hasOwnProperty("onError")&&f.currentCommand.onError(a),f.getContextData().lastError=a,f.intercept("AfterThrowing",d).then(function(){b.reject(a)},function(){b.reject(a)}),b.promise)})}}function j(a,b){h.apply(this,[a]),this.descriptors=b,this.start=function(){return this.deferred=s.defer(),this.execute(),this.deferred.promise}}function k(a,b){j.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c],d=this.context.instantiateDescriptor(b);d instanceof i?d.execute().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)})},this.nextCommand=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function l(a,b){j.apply(this,[a,b]);var c=0;this.execute=function(){for(var a=this,b=0;b<this.descriptors.length;b++){var c=this.descriptors[b],d=this.context.instantiateDescriptor(c);d instanceof i?d.execute().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)})}},this.checkComplete=function(){++c==this.descriptors.length&&this.deferred.resolve()}}function m(a,b){j.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c];if(b instanceof f)if(this.context.contextData[b.key]===b.value){var d=this.context.instantiateDescriptor(b.commandDescriptor);d instanceof i?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next();if(b instanceof g){var e=r.get(b.service);if(e[b.property]===b.value){var d=this.context.instantiateDescriptor(b.commandDescriptor);d instanceof i?d.execute().then(function(){a.next()}):d.start().then(function(){a.next()})}else this.next()}},this.next=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function n(a){this.contextData=a||{},this.instantiator=new o,this.contextData.commandModel={},this.currentDeferred,this.currentCommand,this.canceled=!1}function o(){}function p(a,b){this.deferred=b,this.context=a}function q(a,b,c,d){p.apply(this,[c,d]),this.executed=a,this.next=b}var r,s,t,u=a.commangular||(a.commangular={}),v="",w="",x=[],y=[],z={},A={},B=/\/(.*)\//,C=/@([^(]*)\((.*)\)/;u.create=function(a,b,c){t=u.commands||(u.commands={}),t[a]={"function":b,config:c,interceptors:{},commandName:a},v=v.concat("%"+a+"%{"+a+"}\n")},u.command=u.create,u.aspect=function(a,b,c){x=u.aspects||(u.aspects=[]);var d=C.exec(a),e=d[1],f=B.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg");if(aspectOrder=c||(c=0),!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b|\bAround\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");x.push({poincut:e,matcher:g,aspectFunction:b,order:aspectOrder,descriptor:a})},u.eventAspect=function(a,b,c){y=u.eventAspects||(u.eventAspects=[]);var d=C.exec(a),e=d[1],f=B.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg");if(aspectOrder=c||(c=0),!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");y.push({poincut:e,matcher:g,aspectFunction:b,order:aspectOrder,descriptor:a})},u.resolver=function(a,b){var d=["lastResult","processor",function(c,d){return{execute:function(){var e=r.invoke(b,this,{result:c});return d.setData("lastResult",e),t[a]&&t[a].config&&t[a].config.resultKey&&d.setData(t[a].config.resultKey,e),e}}}],e="@After(/"+c(a)+"/)";u.aspect(e,d,-100)},u.reset=function(){x=[],y=[],t={},u.aspects=[],u.eventAspects=[],u.commands={},A={},v="",w=""},d.prototype.asSequence=function(){return this.commandType="S",this},d.prototype.asParallel=function(){return this.commandType="P",this},d.prototype.asFlow=function(){return this.commandType="F",this},d.prototype.add=function(a){if(b.isString(a)&&(a=u.commands[a]),a instanceof d)return this.descriptors.push(a),this;var c=new d("E");return c.command=a.function,c.commandConfig=a.config,c.interceptors=a.interceptors,this.descriptors.push(c),this},d.prototype.resultLink=function(a,b){var c=new f(a,b,this);return this.descriptors.push(c),c},d.prototype.serviceLink=function(a,b,c){var d=new g(a,b,c,this);return this.descriptors.push(d),d},e.prototype.to=function(a){if(b.isString(a)&&(a=u.commands[a]),a instanceof d)return this.commandDescriptor=a,this.parent;var c=new d("E");return c.command=a.function,c.commandConfig=a.config,c.interceptors=a.interceptors,this.commandDescriptor=c,this.parent},f.prototype=new e,f.prototype.constructor=f,g.prototype=new e,g.prototype.constructor=g,i.prototype=new h,i.prototype.constructor=i,j.prototype=new h,j.prototype.constructor=j,k.prototype=new j,k.prototype.constructor=k,l.prototype=new j,l.prototype.constructor=l,l.prototype=new j,l.prototype.constructor=m,n.prototype.instantiateDescriptor=function(a){var b=this.instantiator.instantiate(a,this);return b},n.prototype.instantiate=function(a,b){return instance=r.instantiate(a,this.contextData),b&&(this.currentCommand=instance),instance},n.prototype.processResults=function(a,b){var c=this,d=s.defer();if(!a)return d.resolve(),d.promise;s.when(a).then(function(a){c.contextData.lastResult=a,b&&b.resultKey&&(c.contextData[b.resultKey]=a),d.resolve()},function(a){d.reject(a)});return d.promise},n.prototype.invoke=function(a,b){return r.invoke(a,b,this.contextData)},n.prototype.getContextData=function(){return this.contextData},n.prototype.intercept=function(a,c,d){var e=this,f=s.defer();if(!c[a])return f.resolve(),f.promise;switch(c[a].sort(function(a,b){return b.order-a.order}),a){case"Around":var g=new q(d,null,e,f);b.forEach(c[a],function(a){g=new q(a.func,g,e,f)}),s.when(g.invoke()).then(function(a){f.resolve(a)},function(a){f.reject(a)});break;default:var g=this.contextData.processor=new p(e,f);c[a].reverse();var h=0;!function i(){try{if(h==c[a].length||e.canceled)return f.resolve(),void 0;var b=e.instantiate(c[a][h++].func,!1);s.when(e.invoke(b.execute,b)).then(function(){i()})}catch(d){f.reject(d)}}()}return f.promise},o.prototype.instantiate=function(a,b){switch(a.commandType){case"S":return new k(b,a.descriptors);case"P":return new l(b,a.descriptors);case"E":return new i(a.command,b,a.commandConfig,a.interceptors);case"F":return new m(b,a.descriptors)}},p.prototype.cancel=function(a){this.context.canceled=!0,this.deferred.reject(a)},p.prototype.setData=function(a,b){this.context.contextData[a]=b},p.prototype.getData=function(a){return this.context.contextData[a]},q.prototype=new p,q.prototype.constructor=q,q.prototype.invoke=function(){var a=this,b=s.defer();a.context.contextData.processor=a.next;var c=a.context.instantiate(a.executed,null==this.next);return s.when(a.context.invoke(c.execute,c)).then(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},b.module("commangular",[]).provider("$commangular",function(){return{$get:["commandExecutor",function(a){return{dispatch:function(b,c){return a.execute(b,c)}}}],mapTo:function(a){var b=A[a]||(A[a]={});b.interceptors||(b.interceptors={}),w=w.concat("%"+a+"%{"+a+"}\n");var c=new d;return z[a]=c,c},asSequence:function(){return new d("S")},asParallel:function(){return new d("P")},asFlow:function(){return new d("F")},findCommand:function(a){return z[a]},modelBinding:function(){}}}),b.module("commangular").service("commandExecutor",function(){return{execute:function(a,b){var c=s.defer(),d=new n(b),e=d.instantiateDescriptor(z[a]),f=A[a].interceptors;return c.resolve(),c.promise.then(function(){return d.intercept("Before",f)}).then(function(){return e.start()}).then(function(){return d.intercept("After",f)}).then(function(){return d.contextData},function(a){var b=s.defer();return d.intercept("AfterThrowing",f).then(function(){b.reject(a)},function(){b.reject(a)}),b.promise})}}}),b.module("commangular").run(["$rootScope","$commangular","$injector","$q",function(a,c,d,e){r=d,s=e,b.forEach(x,function(a){for(;null!=(result=a.matcher.exec(v));)t[result[1]].interceptors[a.poincut]||(t[result[1]].interceptors[a.poincut]=[]),t[result[1]].interceptors[a.poincut].push({func:a.aspectFunction,order:a.order})}),v="",b.forEach(y,function(a){for(;null!=(result=a.matcher.exec(w));)A[result[1]]&&!A[result[1]].interceptors[a.poincut]&&(A[result[1]].interceptors[a.poincut]=[]),A[result[1]].interceptors[a.poincut].push({func:a.aspectFunction,order:a.order})}),w="",a.dispatch=function(a,b){return c.dispatch(a,b)}}])}(window,angular);