/**
 * Command pattern implementation for AngularJS
 * @version v0.8.0 - 2013-12-30
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){function c(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function d(a){this.commandType=a,this.descriptors=[],this.command=null,this.commandConfig,this.interceptors}function e(a,b,c){this.commandDescriptor,this.expresion=a,this.services=b,this.parent=c}function f(a){this.context=a,this.deferred=null}function g(a,b,c,d){f.apply(this,[b]),this.command=a,this.commandConfig=c,this.interceptors=d,this.execute=function(){var b,e=this,f=this.context,g=q.defer();return g.resolve(),g.promise.then(function(){return f.intercept("Before",d)}).then(function(){var g=q.defer();try{d.Around?b=f.intercept("Around",d,e.command):(a=f.instantiate(e.command,!0),b=f.invoke(a.execute,a)),f.processResults(b,c).then(function(){g.resolve()},function(a){g.reject(a)})}catch(h){g.reject(h)}return g.promise}).then(function(){return f.intercept("After",d)}).then(function(){f.currentCommand.hasOwnProperty("onResult")&&f.currentCommand.onResult(b)},function(a){var b=q.defer();return f.canceled?(b.reject(a),b.promise):(f.currentCommand&&f.currentCommand.hasOwnProperty("onError")&&f.currentCommand.onError(a),f.getContextData().lastError=a,f.intercept("AfterThrowing",d).then(function(){b.reject(a)},function(){b.reject(a)}),b.promise)})}}function h(a,b){f.apply(this,[a]),this.descriptors=b,this.start=function(){return this.deferred=q.defer(),this.execute(),this.deferred.promise}}function i(a,b){h.apply(this,[a,b]);var c=0;this.execute=function(){var a=this,b=this.descriptors[c],d=this.context.instantiateDescriptor(b);d instanceof g?d.execute().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.nextCommand()},function(b){a.deferred.reject(b)})},this.nextCommand=function(){return++c==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function j(a,b){h.apply(this,[a,b]);var c=0;this.execute=function(){for(var a=this,b=0;b<this.descriptors.length;b++){var c=this.descriptors[b],d=this.context.instantiateDescriptor(c);d instanceof g?d.execute().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)}):d.start().then(function(){a.checkComplete()},function(b){a.deferred.reject(b)})}},this.checkComplete=function(){++c==this.descriptors.length&&this.deferred.resolve()}}function k(a,c){h.apply(this,[a,c]);var d=0;this.execute=function(){var a=this,c=this.descriptors[d],e={};c.services&&b.forEach(c.services.split(","),function(a){e[a]=p.get(a)});var f=r(c.expresion)(this.context.contextData,e);if("boolean"!=typeof f)throw new Error("Result from expresion :"+c.expresion+" is not boolean");if(f){var h=this.context.instantiateDescriptor(c.commandDescriptor);h instanceof g?h.execute().then(function(){a.next()}):h.start().then(function(){a.next()})}else this.next()},this.next=function(){return++d==this.descriptors.length?(this.deferred.resolve(),void 0):(this.execute(),void 0)}}function l(a){this.contextData=a||{},this.instantiator=new m,this.contextData.commandModel={},this.currentDeferred,this.currentCommand,this.canceled=!1}function m(){}function n(a,b){this.deferred=b,this.context=a}function o(a,b,c,d){n.apply(this,[c,d]),this.executed=a,this.next=b}var p,q,r,s,t=a.commangular||(a.commangular={}),u="",v="",w=[],x=[],y={},z={},A=/\/(.*)\//,B=/@([^(]*)\((.*)\)/;t.create=function(a,b,c){s=t.commands||(t.commands={}),s[a]={"function":b,config:c,interceptors:{},commandName:a},u=u.concat("%"+a+"%{"+a+"}\n")},t.command=t.create,t.aspect=function(a,b,c){w=t.aspects||(t.aspects=[]);var d=B.exec(a),e=d[1],f=A.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg");if(aspectOrder=c||(c=0),!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b|\bAround\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");w.push({poincut:e,matcher:g,aspectFunction:b,order:aspectOrder,descriptor:a})},t.eventAspect=function(a,b,c){x=t.eventAspects||(t.eventAspects=[]);var d=B.exec(a),e=d[1],f=A.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg");if(aspectOrder=c||(c=0),!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");x.push({poincut:e,matcher:g,aspectFunction:b,order:aspectOrder,descriptor:a})},t.resolver=function(a,b){var d=["lastResult","processor",function(c,d){return{execute:function(){var e=p.invoke(b,this,{result:c});return d.setData("lastResult",e),s[a]&&s[a].config&&s[a].config.resultKey&&d.setData(s[a].config.resultKey,e),e}}}],e="@After(/"+c(a)+"/)";t.aspect(e,d,-100)},t.reset=function(){w=[],x=[],s={},t.aspects=[],t.eventAspects=[],t.commands={},z={},u="",v=""},d.prototype.asSequence=function(){return this.commandType="S",this},d.prototype.asParallel=function(){return this.commandType="P",this},d.prototype.asFlow=function(){return this.commandType="F",this},d.prototype.add=function(a){if(b.isString(a)&&(a=t.commands[a]),a instanceof d)return this.descriptors.push(a),this;var c=new d("E");return c.command=a.function,c.commandConfig=a.config,c.interceptors=a.interceptors,this.descriptors.push(c),this},d.prototype.link=function(a,b){var c=new e(a,b,this);return this.descriptors.push(c),c},e.prototype.to=function(a){if(b.isString(a)&&(a=t.commands[a]),a instanceof d)return this.commandDescriptor=a,this.parent;var c=new d("E");return c.command=a.function,c.commandConfig=a.config,c.interceptors=a.interceptors,this.commandDescriptor=c,this.parent},g.prototype=new f,g.prototype.constructor=g,h.prototype=new f,h.prototype.constructor=h,i.prototype=new h,i.prototype.constructor=i,j.prototype=new h,j.prototype.constructor=j,j.prototype=new h,j.prototype.constructor=k,l.prototype.instantiateDescriptor=function(a){var b=this.instantiator.instantiate(a,this);return b},l.prototype.instantiate=function(a,b){return instance=p.instantiate(a,this.contextData),b&&(this.currentCommand=instance),instance},l.prototype.processResults=function(a,b){var c=this,d=q.defer();if(!a)return d.resolve(),d.promise;q.when(a).then(function(a){c.contextData.lastResult=a,b&&b.resultKey&&(c.contextData[b.resultKey]=a),d.resolve()},function(a){d.reject(a)});return d.promise},l.prototype.invoke=function(a,b){return p.invoke(a,b,this.contextData)},l.prototype.getContextData=function(){return this.contextData},l.prototype.intercept=function(a,c,d){var e=this,f=q.defer();if(!c[a])return f.resolve(),f.promise;switch(c[a].sort(function(a,b){return b.order-a.order}),a){case"Around":var g=new o(d,null,e,f);b.forEach(c[a],function(a){g=new o(a.func,g,e,f)}),q.when(g.invoke()).then(function(a){f.resolve(a)},function(a){f.reject(a)});break;default:var g=this.contextData.processor=new n(e,f);c[a].reverse();var h=0;!function i(){try{if(h==c[a].length||e.canceled)return f.resolve(),void 0;var b=e.instantiate(c[a][h++].func,!1);q.when(e.invoke(b.execute,b)).then(function(){i()})}catch(d){f.reject(d)}}()}return f.promise},m.prototype.instantiate=function(a,b){switch(a.commandType){case"S":return new i(b,a.descriptors);case"P":return new j(b,a.descriptors);case"E":return new g(a.command,b,a.commandConfig,a.interceptors);case"F":return new k(b,a.descriptors)}},n.prototype.cancel=function(a){this.context.canceled=!0,this.deferred.reject(a)},n.prototype.setData=function(a,b){this.context.contextData[a]=b},n.prototype.getData=function(a){return this.context.contextData[a]},o.prototype=new n,o.prototype.constructor=o,o.prototype.invoke=function(){var a=this,b=q.defer();a.context.contextData.processor=a.next;var c=a.context.instantiate(a.executed,null==this.next);return q.when(a.context.invoke(c.execute,c)).then(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},b.module("commangular",[]).provider("$commangular",function(){return{$get:["commandExecutor",function(a){return{dispatch:function(b,c){return a.execute(b,c)}}}],mapTo:function(a){var b=z[a]||(z[a]={});b.interceptors||(b.interceptors={}),v=v.concat("%"+a+"%{"+a+"}\n");var c=new d;return y[a]=c,c},asSequence:function(){return new d("S")},asParallel:function(){return new d("P")},asFlow:function(){return new d("F")},findCommand:function(a){return y[a]},modelBinding:function(){}}}),b.module("commangular").service("commandExecutor",function(){return{execute:function(a,b){var c=q.defer(),d=new l(b),e=d.instantiateDescriptor(y[a]),f=z[a].interceptors;return c.resolve(),c.promise.then(function(){return d.intercept("Before",f)}).then(function(){return e.start()}).then(function(){return d.intercept("After",f)}).then(function(){return d.contextData},function(a){var b=q.defer();return d.intercept("AfterThrowing",f).then(function(){b.reject(a)},function(){b.reject(a)}),b.promise})}}}),b.module("commangular").run(["$rootScope","$commangular","$injector","$q","$parse",function(a,c,d,e,f){p=d,q=e,r=f,b.forEach(w,function(a){for(;null!=(result=a.matcher.exec(u));)s[result[1]].interceptors[a.poincut]||(s[result[1]].interceptors[a.poincut]=[]),s[result[1]].interceptors[a.poincut].push({func:a.aspectFunction,order:a.order})}),u="",b.forEach(x,function(a){for(;null!=(result=a.matcher.exec(v));)z[result[1]]&&!z[result[1]].interceptors[a.poincut]&&(z[result[1]].interceptors[a.poincut]=[]),z[result[1]].interceptors[a.poincut].push({func:a.aspectFunction,order:a.order})}),v="",a.dispatch=function(a,b){return c.dispatch(a,b)}}])}(window,angular);